<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAMA AI Roleplay Evaluation System</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#111b33;
      --card2:#0f1730;
      --text:#e9eefc;
      --muted:#a8b3d6;
      --brand:#7aa2ff;
      --ok:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --line:rgba(255,255,255,.08);
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans Thai", "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1000px 600px at 20% 10%, rgba(122,162,255,.18), transparent 60%),
                  radial-gradient(1000px 600px at 90% 80%, rgba(52,211,153,.12), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    a{color:var(--brand)}
    .wrap{max-width:1200px;margin:0 auto;padding:22px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border:1px solid var(--line);border-radius:18px;background:rgba(17,27,51,.6);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .brand{
      display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px
    }
    .dot{width:12px;height:12px;border-radius:999px;background:var(--brand);box-shadow:0 0 0 6px rgba(122,162,255,.15)}
    .nav{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      appearance:none;border:1px solid var(--line);background:rgba(255,255,255,.06);
      color:var(--text);padding:10px 12px;border-radius:14px;cursor:pointer;
      font-weight:700;letter-spacing:.2px;
    }
    .btn:hover{border-color:rgba(122,162,255,.35)}
    .btn.primary{background:rgba(122,162,255,.18);border-color:rgba(122,162,255,.35)}
    .btn.danger{background:rgba(251,113,133,.12);border-color:rgba(251,113,133,.25)}
    .btn.ok{background:rgba(52,211,153,.12);border-color:rgba(52,211,153,.25)}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:16px}
    @media(min-width:980px){ .grid{grid-template-columns: 1.1fr .9fr} }
    .card{
      border:1px solid var(--line);border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(17,27,51,.75), rgba(15,23,48,.65));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .card .hd h2{margin:0;font-size:16px}
    .card .bd{padding:16px}
    .muted{color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:720px){ .row{grid-template-columns:1fr 1fr} }
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(0,0,0,.25);color:var(--text);
      outline:none;
    }
    textarea{min-height:110px;resize:vertical}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border:1px solid var(--line);border-radius:999px;
      background:rgba(255,255,255,.06);font-weight:700;font-size:12px;
    }
    .pill.ok{border-color:rgba(52,211,153,.35);background:rgba(52,211,153,.12)}
    .pill.warn{border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.12)}
    .pill.bad{border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.12)}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(min-width:720px){.kpi{grid-template-columns:repeat(3,1fr)}}
    .kpi .box{padding:14px;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.05)}
    .kpi .box .v{font-size:28px;font-weight:900}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;font-size:13px}
    .table th{color:var(--muted);font-weight:800}
    .badge{font-weight:900}
    .bigscore{font-size:64px;font-weight:1000;line-height:1;margin:0}
    .cert{
      border:1px solid rgba(122,162,255,.25);
      background:linear-gradient(135deg, rgba(122,162,255,.20), rgba(0,0,0,.20));
      border-radius:22px;padding:18px;
    }
    .cert .title{font-weight:1000;font-size:18px}
    .cert .name{font-weight:1000;font-size:22px;margin-top:6px}
    .cert .meta{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .cert .meta .pill{background:rgba(0,0,0,.18)}
    .footnote{font-size:12px;color:var(--muted);margin-top:12px}
    .toast{
      position:fixed;right:16px;bottom:16px;max-width:420px;
      padding:12px 14px;border-radius:16px;border:1px solid var(--line);
      background:rgba(17,27,51,.9);backdrop-filter: blur(10px);
      box-shadow: var(--shadow);display:none;
    }
    .toast.show{display:block}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <span class="dot"></span>
      <div>
        <div style="font-size:14px">MAMA AI Roleplay Evaluation</div>
        <div class="muted" style="font-size:12px">Production Package (HTML + Supabase + Edge Functions)</div>
      </div>
    </div>
    <div class="nav">
      <button class="btn" id="nav_user">User Flow</button>
      <button class="btn" id="nav_admin">Admin Panel</button>
      <button class="btn" id="nav_rank">Rankings</button>
      <button class="btn danger" id="nav_reset">Reset</button>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: Main Flow -->
    <div class="card" id="panel_main">
      <div class="hd">
        <h2 id="main_title">Access Verification</h2>
        <span class="pill" id="status_pill">READY</span>
      </div>
      <div class="bd" id="main_body"></div>
    </div>

    <!-- RIGHT: Context / Live -->
    <div class="card">
      <div class="hd">
        <h2>Session Monitor</h2>
        <span class="pill mono" id="session_id_pill">-</span>
      </div>
      <div class="bd">
        <div class="kpi">
          <div class="box">
            <div class="muted">Course</div>
            <div class="v" id="kpi_course">-</div>
          </div>
          <div class="box">
            <div class="muted">Stage</div>
            <div class="v" id="kpi_stage">-</div>
          </div>
          <div class="box">
            <div class="muted">Timer</div>
            <div class="v mono" id="kpi_timer">00:00</div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="muted" style="font-size:12px;margin-bottom:6px">Scenario / Persona / Objection</div>
        <div class="pill" id="pill_scenario">Scenario: -</div>
        <div style="height:8px"></div>
        <div class="pill" id="pill_persona">CEO Persona: -</div>
        <div style="height:8px"></div>
        <div class="pill" id="pill_objection">Objection: -</div>
        <div class="hr"></div>
        <div class="muted" style="font-size:12px">Notes</div>
        <div class="hint" id="notes">
          - Passcode: mama / admin2026 (case-insensitive)<br/>
          - Minimum audio: 5 seconds<br/>
          - Certificate: PASS >= 70
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Panel -->
  <div class="card" id="panel_admin" style="margin-top:16px;display:none">
    <div class="hd">
      <h2>Admin Panel</h2>
      <span class="pill warn">Restricted</span>
    </div>
    <div class="bd" id="admin_body"></div>
  </div>

  <!-- Rankings -->
  <div class="card" id="panel_rank" style="margin-top:16px;display:none">
    <div class="hd">
      <h2>Rankings Dashboard</h2>
      <span class="pill ok">Live</span>
    </div>
    <div class="bd" id="rank_body"></div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
/* ============================================================
   CONFIG
============================================================ */
const SUPABASE_URL = "https://iuwszegqtgtvupavoucv.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1d3N6ZWdxdGd0dnVwYXZvdWN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3ODE3MDIsImV4cCI6MjA4NTM1NzcwMn0.z5DmbtLgULN-DjOnM6PrD9puKmKS_vd2rD5hp0huM6g";
const BUCKET = "roleplay-audio";

/* Edge Function Endpoints (Supabase auto host) */
const FN_UPLOAD_SIGN = `${SUPABASE_URL}/functions/v1/upload-sign`;
const FN_EVALUATE = `${SUPABASE_URL}/functions/v1/evaluate-roleplay`;
const FN_ADMIN = `${SUPABASE_URL}/functions/v1/admin-api`;
const FN_RANK = `${SUPABASE_URL}/functions/v1/ranking-api`;

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ============================================================
   STATE
============================================================ */
const state = {
  pass_ok: false,
  admin_ok: false,
  admin_pass: "",
  user_log: null,
  session_id: null,
  course: null,
  stage: "A",
  scenario: null,
  persona: null,
  objection: null,
  audio: { A: null, B: null },
  audioSeconds: 0,
  timer: { startAt: null, t: null, seconds: 0 },
  cfg: { minAudio: 5, passScore: 70, passcodes: { user:"mama", admin:"admin2026" } }
};

/* ============================================================
   UI HELPERS
============================================================ */
const $ = (id)=>document.getElementById(id);
function toast(msg){
  const t = $("toast");
  t.innerHTML = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 3400);
}
function setStatus(text, type=""){
  const pill = $("status_pill");
  pill.textContent = text;
  pill.className = "pill " + (type||"");
}
function setMainTitle(t){ $("main_title").textContent = t; }
function setMonitor(){
  $("session_id_pill").textContent = state.session_id ? state.session_id.slice(0,8) : "-";
  $("kpi_course").textContent = state.course || "-";
  $("kpi_stage").textContent = state.stage || "-";
  $("pill_scenario").textContent = "Scenario: " + (state.scenario?.title || "-");
  $("pill_persona").textContent = "CEO Persona: " + (state.persona?.name || "-");
  $("pill_objection").textContent = "Objection: " + (state.objection?.objection || "-");
}
function mmss(sec){
  const m = Math.floor(sec/60);
  const s = sec%60;
  return String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
}
function startTimer(){
  stopTimer();
  state.timer.startAt = Date.now();
  state.timer.t = setInterval(()=>{
    state.timer.seconds = Math.floor((Date.now()-state.timer.startAt)/1000);
    $("kpi_timer").textContent = mmss(state.timer.seconds);
  }, 250);
}
function stopTimer(){
  if(state.timer.t) clearInterval(state.timer.t);
  state.timer.t = null;
  state.timer.startAt = null;
  state.timer.seconds = 0;
  $("kpi_timer").textContent = "00:00";
}

/* ============================================================
   DATA LOAD
============================================================ */
async function loadConfigs(){
  const { data, error } = await supabase.from("system_configs").select("*").in("key", ["passcodes","min_audio_seconds","certificate"]).order("key");
  if(error){ console.error(error); toast("Config load failed"); return; }
  for(const row of data){
    if(row.key==="passcodes") state.cfg.passcodes = row.value;
    if(row.key==="min_audio_seconds") state.cfg.minAudio = row.value?.seconds ?? 5;
    if(row.key==="certificate") state.cfg.passScore = row.value?.pass_score ?? 70;
  }
}

/* ============================================================
   RH/ZONE MAP
============================================================ */
const RH_ZONES = {
  RH1: ["จตุจักร","ธนบุรี","บางกะปิ","สาทร","สุขุมวิท"],
  RH2: ["ชลบุรี","บางนา","พัทยา","ระยอง"],
  RH3: ["เชียงใหม่","นครสวรรค์","นนทบุรี","พิษณุโลก","อยุธยา"],
  RH4: ["ดอนเมือง","นครราชสีมา","สระบุรี","อุดรธานี","อุบลราชธานี"],
  RH5: ["ภูเก็ต","ราชบุรี","สมุทรสาคร","สุราษฎร์ธานี","หาดใหญ่"]
};

/* ============================================================
   AUDIO RECORDING (MediaRecorder)
============================================================ */
async function recordAudioUI(stage){
  const minSec = state.cfg.minAudio || 5;

  return `
    <div class="pill ${stage==='A'?'ok':'warn'}">Stage ${stage}: ${stage==='A'?'Presentation':'Objection Handling'}</div>
    <div style="height:12px"></div>
    <div class="row">
      <div>
        <button class="btn primary" id="btn_start">Start Recording</button>
        <button class="btn" id="btn_stop" disabled>Stop</button>
        <div class="hint">ต้องอัดอย่างน้อย ${minSec} วินาที</div>
      </div>
      <div>
        <audio id="audio_preview" controls style="width:100%;margin-top:6px"></audio>
        <div class="hint">เมื่ออัดเสร็จ ให้กด Upload</div>
      </div>
    </div>
    <div style="height:12px"></div>
    <button class="btn ok" id="btn_upload" disabled>Upload Stage ${stage}</button>
    <div class="hint" id="rec_hint"></div>
  `;
}

async function initRecorder(stage){
  const startBtn = $("btn_start");
  const stopBtn = $("btn_stop");
  const uploadBtn = $("btn_upload");
  const preview = $("audio_preview");
  const hint = $("rec_hint");

  let stream, recorder, chunks=[];
  let blob=null;

  async function ensureMic(){
    stream = await navigator.mediaDevices.getUserMedia({ audio:true });
  }

  startBtn.onclick = async ()=>{
    try{
      await ensureMic();
      chunks=[];
      recorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
      recorder.ondataavailable = (e)=>{ if(e.data.size>0) chunks.push(e.data); };
      recorder.onstop = ()=>{
        blob = new Blob(chunks, { type:"audio/webm" });
        const url = URL.createObjectURL(blob);
        preview.src = url;
        const sec = state.timer.seconds;
        state.audioSeconds = sec;
        if(sec >= (state.cfg.minAudio||5)){
          uploadBtn.disabled=false;
          hint.innerHTML = `<span class="pill ok">Recorded ${sec}s</span>`;
        }else{
          uploadBtn.disabled=true;
          hint.innerHTML = `<span class="pill bad">Recorded ${sec}s (ขั้นต่ำ ${(state.cfg.minAudio||5)}s)</span>`;
        }
      };
      recorder.start();
      startTimer();
      startBtn.disabled=true;
      stopBtn.disabled=false;
      uploadBtn.disabled=true;
      hint.textContent="Recording...";
    }catch(e){
      console.error(e);
      toast("Mic permission required");
    }
  };

  stopBtn.onclick = ()=>{
    try{
      recorder.stop();
      stopTimer();
      startBtn.disabled=false;
      stopBtn.disabled=true;
      if(stream) stream.getTracks().forEach(t=>t.stop());
    }catch(e){}
  };

  uploadBtn.onclick = async ()=>{
    if(!blob) return;
    if(state.audioSeconds < (state.cfg.minAudio||5)){
      toast("Audio too short");
      return;
    }
    setStatus("UPLOADING...", "warn");
    uploadBtn.disabled=true;

    try{
      // 1) get signed upload URL
      const signRes = await fetch(FN_UPLOAD_SIGN, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ session_id: state.session_id, stage })
      });
      const sign = await signRes.json();
      if(!signRes.ok) throw new Error(sign.error || "sign failed");

      // 2) upload via signed URL
      const up = await fetch(sign.signedUrl, {
        method:"PUT",
        headers:{ "Content-Type":"audio/webm" },
        body: blob
      });
      if(!up.ok){
        const t = await up.text();
        throw new Error("upload failed: "+t);
      }

      // 3) update session audio path
      const col = stage==="A" ? { audio_a_path: sign.path, stage_a_uploaded_at: new Date().toISOString(), status:"A_UPLOADED" }
                              : { audio_b_path: sign.path, stage_b_uploaded_at: new Date().toISOString(), status:"B_UPLOADED" };

      const { error } = await supabase.from("roleplay_sessions").update(col).eq("id", state.session_id);
      if(error) throw error;

      state.audio[stage] = sign.path;

      if(stage==="A"){
        // Trigger objection show (business rule)
        await assignObjection();
        state.stage="B";
        setMonitor();
        toast("Stage A uploaded. Objection revealed.");
        renderStageB();
      }else{
        toast("Stage B uploaded. Ready for AI Evaluation.");
        renderEvaluate();
      }

    }catch(e){
      console.error(e);
      toast("Upload failed: "+e.message);
      setStatus("ERROR", "bad");
      uploadBtn.disabled=false;
      return;
    }
  };
}

/* ============================================================
   FLOW: PASSCODE
============================================================ */
async function renderPasscode(){
  setMainTitle("Access Verification (Passcode)");
  setStatus("WAITING PASSCODE", "warn");
  state.pass_ok=false; state.admin_ok=false;
  state.user_log=null; state.session_id=null; state.course=null;
  state.stage="A"; state.scenario=null; state.persona=null; state.objection=null;
  setMonitor();

  $("main_body").innerHTML = `
    <div class="muted">กรอกรหัสเพื่อเข้าใช้งานระบบ</div>
    <div style="height:10px"></div>
    <label>Passcode</label>
    <input id="passcode" placeholder="mama / admin2026" />
    <div class="hint">Case-insensitive</div>
    <div style="height:12px"></div>
    <button class="btn primary" id="btn_pass">Verify</button>
  `;

  $("btn_pass").onclick = async ()=>{
    const input = ($("passcode").value||"").trim().toLowerCase();
    const user = String(state.cfg.passcodes?.user ?? "mama").toLowerCase();
    const admin = String(state.cfg.passcodes?.admin ?? "admin2026").toLowerCase();

    if(!input){ toast("กรุณากรอก passcode"); return; }

    if(input === admin){
      state.admin_ok=true;
      state.admin_pass = $("passcode").value.trim();
      setStatus("ADMIN VERIFIED", "ok");
      toast("Admin access granted");
      showAdminPanel();
      return;
    }

    if(input === user){
      state.pass_ok=true;
      setStatus("USER VERIFIED", "ok");
      toast("Access granted");
      renderRegistration();
      return;
    }

    setStatus("DENIED", "bad");
    toast("Passcode ไม่ถูกต้อง");
  };
}

/* ============================================================
   FLOW: REGISTRATION
============================================================ */
function renderRegistration(){
  setMainTitle("User Registration");
  setStatus("REGISTER", "warn");

  $("main_body").innerHTML = `
    <div class="muted">ลงทะเบียนเพื่อเริ่ม Roleplay</div>
    <div style="height:12px"></div>

    <div class="row">
      <div>
        <label>Employee ID (Numeric Only)</label>
        <input id="emp_id" inputmode="numeric" placeholder="เช่น 123456" />
      </div>
      <div>
        <label>Position</label>
        <select id="position">
          <option value="">เลือก</option>
          <option>CFSA</option>
          <option>CISA</option>
          <option>BM</option>
          <option>WRM</option>
          <option>IS</option>
          <option>IA</option>
          <option>Other</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div>
        <label>First Name</label>
        <input id="fname" placeholder="ชื่อ" />
      </div>
      <div>
        <label>Last Name</label>
        <input id="lname" placeholder="นามสกุล" />
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div>
        <label>Region (RH)</label>
        <select id="rh">
          <option value="">เลือก RH</option>
          <option>RH1</option><option>RH2</option><option>RH3</option><option>RH4</option><option>RH5</option>
        </select>
      </div>
      <div>
        <label>Zone (District)</label>
        <select id="zone" disabled>
          <option value="">เลือก Zone</option>
        </select>
        <div class="hint">Zone จะปลดล็อกเมื่อเลือก RH</div>
      </div>
    </div>

    <div style="height:12px"></div>
    <button class="btn primary" id="btn_reg">Continue</button>
  `;

  const rh = $("rh");
  const zone = $("zone");

  rh.onchange = ()=>{
    const v = rh.value;
    zone.innerHTML = `<option value="">เลือก Zone</option>`;
    if(!v){ zone.disabled=true; return; }
    zone.disabled=false;
    for(const z of RH_ZONES[v] || []){
      const o = document.createElement("option");
      o.textContent = z; o.value = z;
      zone.appendChild(o);
    }
  };

  $("btn_reg").onclick = async ()=>{
    const emp_id = ($("emp_id").value||"").trim();
    const fname = ($("fname").value||"").trim();
    const lname = ($("lname").value||"").trim();
    const position = ($("position").value||"").trim();
    const region = ($("rh").value||"").trim();
    const z = ($("zone").value||"").trim();

    if(!/^\d+$/.test(emp_id)){ toast("Employee ID ต้องเป็นตัวเลขเท่านั้น"); return; }
    if(!fname || !lname || !position || !region || !z){ toast("กรุณากรอกข้อมูลให้ครบทุกช่อง"); return; }

    setStatus("SAVING...", "warn");
    const { data, error } = await supabase.from("users_log").insert({
      employee_id: emp_id,
      first_name: fname,
      last_name: lname,
      position,
      region,
      zone: z
    }).select("*").single();

    if(error){ console.error(error); setStatus("ERROR", "bad"); toast("Register failed"); return; }

    state.user_log = data;
    setStatus("REGISTERED", "ok");
    toast("Registration complete");
    renderCourseSelect();
  };
}

/* ============================================================
   FLOW: COURSE + SCENARIO
============================================================ */
async function renderCourseSelect(){
  setMainTitle("Course Selection");
  setStatus("SELECT COURSE", "warn");

  $("main_body").innerHTML = `
    <div class="muted">เลือกหลักสูตรเพื่อเริ่ม Roleplay</div>
    <div style="height:12px"></div>
    <label>Course</label>
    <select id="course">
      <option value="">เลือก</option>
      <option>MAMA1</option>
      <option>MAMA2</option>
      <option>Other</option>
    </select>
    <div style="height:12px"></div>
    <button class="btn primary" id="btn_course">Start</button>
  `;

  $("btn_course").onclick = async ()=>{
    const course = $("course").value;
    if(!course){ toast("กรุณาเลือกหลักสูตร"); return; }
    state.course = course;
    setMonitor();

    setStatus("FETCHING SCENARIO...", "warn");

    // Random scenario (active, course)
    const { data: sc, error: scErr } = await supabase
      .from("scenarios").select("*").eq("course", course).eq("is_active", true);
    if(scErr){ console.error(scErr); toast("Scenario load failed"); setStatus("ERROR", "bad"); return; }
    if(!sc || sc.length===0){ toast("ไม่มี Scenario ในหลักสูตรนี้"); setStatus("ERROR", "bad"); return; }
    state.scenario = sc[Math.floor(Math.random()*sc.length)];

    // Random CEO persona
    const { data: ceo, error: ceErr } = await supabase.from("ceo_personas").select("*").eq("is_active", true);
    if(ceErr){ console.error(ceErr); toast("Persona load failed"); setStatus("ERROR", "bad"); return; }
    state.persona = (ceo && ceo.length) ? ceo[Math.floor(Math.random()*ceo.length)] : null;

    // Create roleplay session
    const { data: sess, error: seErr } = await supabase.from("roleplay_sessions").insert({
      user_log_id: state.user_log.id,
      course,
      scenario_id: state.scenario.id,
      ceo_persona_id: state.persona?.id ?? null,
      status: "CREATED"
    }).select("*").single();

    if(seErr){ console.error(seErr); toast("Session create failed"); setStatus("ERROR","bad"); return; }

    state.session_id = sess.id;
    state.stage="A";
    state.objection = null;
    setMonitor();
    setStatus("READY STAGE A", "ok");
    renderStageA();
  };
}

function renderStageA(){
  setMainTitle("Roleplay Stage 1 (Presentation)");
  setStatus("RECORD STAGE A", "warn");
  setMonitor();

  $("main_body").innerHTML = `
    <div class="pill ok">Mission</div>
    <div style="height:8px"></div>
    <div style="padding:14px;border:1px solid var(--line);border-radius:16px;background:rgba(0,0,0,.18)">
      <div style="font-weight:900">${state.scenario.title}</div>
      <div class="hint">${state.scenario.context}</div>
      <div class="hr"></div>
      <div><b>ภารกิจ:</b> ${state.scenario.mission}</div>
      ${state.scenario.constraints ? `<div class="hint"><b>Constraints:</b> ${state.scenario.constraints}</div>` : ``}
      ${state.persona ? `<div class="hr"></div><div class="hint"><b>CEO Persona:</b> ${state.persona.persona}</div>` : ``}
    </div>
    <div class="hr"></div>
    <div id="rec_area"></div>
  `;

  (async()=>{
    $("rec_area").innerHTML = await recordAudioUI("A");
    initRecorder("A");
  })();
}

async function assignObjection(){
  // Business rule: only after A uploaded
  const course = state.course;

  const { data: obs, error } = await supabase
    .from("objections").select("*").eq("course", course).eq("is_active", true);

  if(error) throw error;
  if(!obs || obs.length===0) return;

  state.objection = obs[Math.floor(Math.random()*obs.length)];
  setMonitor();

  // update session with objection_id
  await supabase.from("roleplay_sessions").update({ objection_id: state.objection.id }).eq("id", state.session_id);
}

function renderStageB(){
  setMainTitle("Roleplay Stage 2 (Objection Handling)");
  setStatus("RECORD STAGE B", "warn");
  setMonitor();

  $("main_body").innerHTML = `
    <div class="pill warn">Objection Trigger</div>
    <div style="height:8px"></div>
    <div style="padding:14px;border:1px solid rgba(251,191,36,.25);border-radius:16px;background:rgba(251,191,36,.08)">
      <div style="font-weight:1000">ข้อโต้แย้ง (สุ่มหลัง Stage A)</div>
      <div style="margin-top:8px">${state.objection?.objection ?? "—"}</div>
      <div class="hint" style="margin-top:8px">ให้ตอบโต้ข้อโต้แย้งอย่างมีหลักการ</div>
    </div>
    <div class="hr"></div>
    <div id="rec_area"></div>
  `;

  (async()=>{
    $("rec_area").innerHTML = await recordAudioUI("B");
    initRecorder("B");
  })();
}

/* ============================================================
   FLOW: AI EVALUATION
============================================================ */
function renderEvaluate(){
  setMainTitle("AI Evaluation");
  setStatus("READY TO EVALUATE", "ok");
  setMonitor();

  $("main_body").innerHTML = `
    <div class="muted">ระบบจะส่งเสียงทั้ง 2 ชุดให้ AI ประเมิน 5 มิติ</div>
    <div style="height:12px"></div>
    <div class="pill">Rapport / Discovery / Solution / Handling Objection / Technique</div>
    <div style="height:12px"></div>
    <button class="btn primary" id="btn_eval">Run AI Evaluation</button>
    <div class="hint" id="eval_hint"></div>
  `;

  $("btn_eval").onclick = async ()=>{
    $("btn_eval").disabled=true;
    setStatus("EVALUATING...", "warn");
    $("eval_hint").textContent="Processing...";
    try{
      const res = await fetch(FN_EVALUATE, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ session_id: state.session_id })
      });
      const out = await res.json();
      if(!res.ok) throw new Error(out.error || "evaluation failed");
      toast("Evaluation complete");
      setStatus("EVALUATED", "ok");
      renderReport(out);
    }catch(e){
      console.error(e);
      setStatus("ERROR", "bad");
      toast("AI Evaluation failed: "+e.message);
      $("btn_eval").disabled=false;
      $("eval_hint").textContent="";
    }
  };
}

/* ============================================================
   REPORT + CERTIFICATE
============================================================ */
function scorePill(score){
  if(score>=85) return "ok";
  if(score>=70) return "warn";
  return "bad";
}
function renderReport(out){
  setMainTitle("Evaluation Report & Certificate");
  setMonitor();

  const pass = out.total_score >= (state.cfg.passScore||70);

  $("main_body").innerHTML = `
    <div class="row">
      <div class="card" style="background:transparent;border:none;box-shadow:none">
        <div class="bd" style="padding:0">
          <div class="muted">คะแนนรวม</div>
          <p class="bigscore">${out.total_score}</p>
          <div class="pill ${pass?'ok':'bad'}">${pass?'PASS':'NOT PASS'}</div>
        </div>
      </div>
      <div>
        <div class="cert">
          <div class="title">Certificate of Roleplay Evaluation</div>
          <div class="name">${state.user_log.first_name} ${state.user_log.last_name}</div>
          <div class="meta">
            <span class="pill">Employee ID: <b>${state.user_log.employee_id}</b></span>
            <span class="pill">Course: <b>${state.course}</b></span>
            <span class="pill ${pass?'ok':'bad'}">Status: <b>${pass?'PASS':'NOT PASS'}</b></span>
          </div>
          <div class="hr"></div>
          <div class="row">
            <div class="pill ${scorePill(out.rapport)}">Rapport: <b>${out.rapport}</b></div>
            <div class="pill ${scorePill(out.discovery)}">Discovery: <b>${out.discovery}</b></div>
            <div class="pill ${scorePill(out.solution)}">Solution: <b>${out.solution}</b></div>
            <div class="pill ${scorePill(out.handling_objection)}">Handling Objection: <b>${out.handling_objection}</b></div>
            <div class="pill ${scorePill(out.technique)}">Technique: <b>${out.technique}</b></div>
          </div>
          <div class="footnote">ระบบออกใบ Certificate ให้ทุกคนหลังประเมินเสร็จ (PASS ≥ ${state.cfg.passScore})</div>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <div>
        <div class="pill ok">สิ่งที่ทำได้ดี</div>
        <div style="height:8px"></div>
        <div style="padding:14px;border:1px solid var(--line);border-radius:16px;background:rgba(0,0,0,.18)">
          ${escapeHtml(out.strengths || "-")}
        </div>
      </div>
      <div>
        <div class="pill warn">สิ่งที่ควรพัฒนา</div>
        <div style="height:8px"></div>
        <div style="padding:14px;border:1px solid var(--line);border-radius:16px;background:rgba(0,0,0,.18)">
          ${escapeHtml(out.improvements || "-")}
        </div>
      </div>
    </div>

    <div class="hr"></div>
    <button class="btn primary" id="btn_restart">Start New Roleplay</button>
  `;

  $("btn_restart").onclick = ()=>{
    toast("Resetting flow...");
    renderPasscode();
  };
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (c)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}

/* ============================================================
   ADMIN PANEL
============================================================ */
function showAdminPanel(){
  $("panel_admin").style.display = "block";
  $("panel_rank").style.display = "none";
  $("panel_main").scrollIntoView({ behavior:"smooth" });
  renderAdmin();
}

function renderAdmin(){
  $("admin_body").innerHTML = `
    <div class="row">
      <div>
        <div class="pill warn">Admin Passcode</div>
        <div style="height:8px"></div>
        <input id="admin_pass" placeholder="admin2026" value="${state.admin_pass || ""}" />
        <div class="hint">ใช้สำหรับเรียก Edge Function admin-api</div>
      </div>
      <div>
        <div class="pill">Quick Actions</div>
        <div style="height:8px"></div>
        <button class="btn primary" id="btn_reload">Reload Lists</button>
        <button class="btn danger" id="btn_resetpass">Reset User Passcode</button>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <div>
        <h3 style="margin:0 0 10px 0">Prompt Management (Overwrite)</h3>
        <label>Course</label>
        <select id="p_course">
          <option>MAMA1</option><option>MAMA2</option><option>Other</option>
        </select>
        <div style="height:10px"></div>
        <label>Prompt</label>
        <textarea id="p_text" placeholder="ใส่ prompt ใหม่เพื่อ overwrite"></textarea>
        <div style="height:10px"></div>
        <button class="btn ok" id="btn_prompt">Overwrite Prompt</button>
      </div>

      <div>
        <h3 style="margin:0 0 10px 0">Data Management</h3>
        <div class="hint">Scenario / CEO Persona / Objections / Gemini Keys</div>
        <div style="height:10px"></div>
        <button class="btn" id="btn_manage_s">Manage Scenarios</button>
        <button class="btn" id="btn_manage_c">Manage CEO Personas</button>
        <button class="btn" id="btn_manage_o">Manage Objections</button>
        <button class="btn" id="btn_manage_k">Manage Gemini Keys</button>
        <div style="height:10px"></div>
        <div id="admin_manage"></div>
      </div>
    </div>
  `;

  $("btn_reload").onclick = ()=>{ toast("Reload ready"); };
  $("btn_resetpass").onclick = async ()=>{
    const pass = ($("admin_pass").value||"").trim();
    const newp = prompt("New USER passcode (case-insensitive):", "mama");
    if(!newp) return;
    await adminCall(pass, "passcode_reset", { user_passcode: newp });
    toast("User passcode updated");
    await loadConfigs();
  };

  $("btn_prompt").onclick = async ()=>{
    const pass = ($("admin_pass").value||"").trim();
    const course = $("p_course").value;
    const promptText = $("p_text").value.trim();
    if(!promptText){ toast("Prompt empty"); return; }
    await adminCall(pass, "prompt_overwrite", { course, prompt: promptText });
    toast("Prompt overwritten");
  };

  $("btn_manage_s").onclick = ()=>manageTable("scenarios");
  $("btn_manage_c").onclick = ()=>manageTable("ceo_personas");
  $("btn_manage_o").onclick = ()=>manageTable("objections");
  $("btn_manage_k").onclick = ()=>manageTable("gemini_keys");
}

async function adminCall(admin_passcode, action, payload){
  setStatus("ADMIN...", "warn");
  const res = await fetch(FN_ADMIN, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ admin_passcode, action, payload })
  });
  const out = await res.json();
  if(!res.ok){
    setStatus("ADMIN ERROR", "bad");
    toast(out.error || "Admin error");
    throw new Error(out.error || "Admin error");
  }
  setStatus("ADMIN OK", "ok");
  return out;
}

async function manageTable(table){
  const pass = ($("admin_pass").value||"").trim();
  const box = $("admin_manage");
  box.innerHTML = `<div class="pill">Loading ${table}...</div>`;

  const { data, error } = await supabase.from(table).select("*").limit(50);
  if(error){ box.innerHTML = `<div class="pill bad">Load failed</div>`; return; }

  const cols = Object.keys((data[0]||{id:""}));
  box.innerHTML = `
    <div class="pill">Table: <b>${table}</b></div>
    <div style="height:10px"></div>
    <button class="btn ok" id="btn_add">Add New</button>
    <div style="height:10px"></div>
    <div style="max-height:360px;overflow:auto;border:1px solid var(--line);border-radius:16px">
      <table class="table">
        <thead><tr>${cols.map(c=>`<th>${c}</th>`).join("")}<th>Actions</th></tr></thead>
        <tbody>
          ${data.map(r=>`
            <tr>
              ${cols.map(c=>`<td>${escapeHtml(r[c])}</td>`).join("")}
              <td>
                <button class="btn" data-edit="${r.id}">Edit</button>
                <button class="btn danger" data-del="${r.id}">Del</button>
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;

  $("btn_add").onclick = async ()=>{
    const json = prompt("Insert JSON object:", table==="scenarios"
      ? '{"course":"MAMA1","title":"...","mission":"...","context":"...","constraints":"","is_active":true}'
      : table==="objections"
        ? '{"course":"MAMA1","objection":"...","is_active":true}'
        : table==="ceo_personas"
          ? '{"name":"CEO A","persona":"...","is_active":true}'
          : '{"key_name":"key1","api_key":"...","quota_daily":1000,"used_today":0,"is_active":true}'
    );
    if(!json) return;
    await adminCall(pass, "crud", { table, op:"insert", data: JSON.parse(json) });
    toast("Inserted");
    manageTable(table);
  };

  box.querySelectorAll("[data-edit]").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute("data-edit");
      const json = prompt("Update JSON object:", "{}");
      if(!json) return;
      await adminCall(pass, "crud", { table, op:"update", id, data: JSON.parse(json) });
      toast("Updated");
      manageTable(table);
    };
  });

  box.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute("data-del");
      if(!confirm("Delete this record?")) return;
      await adminCall(pass, "crud", { table, op:"delete", id });
      toast("Deleted");
      manageTable(table);
    };
  });
}

/* ============================================================
   RANKINGS
============================================================ */
async function showRankings(){
  $("panel_rank").style.display = "block";
  $("panel_admin").style.display = "none";
  $("panel_rank").scrollIntoView({ behavior:"smooth" });

  $("rank_body").innerHTML = `
    <div class="row">
      <div>
        <button class="btn primary" id="r_global">Global Top 5</button>
        <button class="btn" id="r_course">Course Top 10</button>
        <button class="btn" id="r_regional">Regional Top 10</button>
      </div>
      <div>
        <button class="btn ok" id="r_active">Active Users (24h)</button>
      </div>
    </div>
    <div style="height:12px"></div>
    <div id="rank_out"></div>
  `;

  $("r_global").onclick = ()=>loadRank("global");
  $("r_course").onclick = ()=>{
    const course = prompt("Course:", "MAMA1") || "MAMA1";
    loadRank("course", { course });
  };
  $("r_regional").onclick = ()=>{
    const course = prompt("Course:", "MAMA1") || "MAMA1";
    const region = prompt("Region:", "RH1") || "RH1";
    loadRank("regional", { course, region });
  };
  $("r_active").onclick = ()=>loadRank("active");

  loadRank("global");
}

async function loadRank(type, params={}){
  const out = $("rank_out");
  out.innerHTML = `<div class="pill">Loading...</div>`;
  const url = new URL(FN_RANK);
  url.searchParams.set("type", type);
  for(const [k,v] of Object.entries(params)) url.searchParams.set(k, v);

  const res = await fetch(url.toString());
  const json = await res.json();
  if(!res.ok){ out.innerHTML = `<div class="pill bad">${escapeHtml(json.error||"error")}</div>`; return; }

  if(type==="active"){
    out.innerHTML = `<div class="kpi"><div class="box"><div class="muted">Active Users (24h)</div><div class="v">${json.data.active_users}</div></div></div>`;
    return;
  }

  const rows = json.data || [];
  if(rows.length===0){ out.innerHTML = `<div class="pill warn">No data</div>`; return; }

  const cols = Object.keys(rows[0]);
  out.innerHTML = `
    <div style="max-height:420px;overflow:auto;border:1px solid var(--line);border-radius:16px">
      <table class="table">
        <thead><tr>${cols.map(c=>`<th>${c}</th>`).join("")}</tr></thead>
        <tbody>
          ${rows.map(r=>`<tr>${cols.map(c=>`<td>${escapeHtml(r[c])}</td>`).join("")}</tr>`).join("")}
        </tbody>
      </table>
    </div>
  `;
}

/* ============================================================
   NAV + INIT
============================================================ */
$("nav_user").onclick = ()=>{
  $("panel_admin").style.display="none";
  $("panel_rank").style.display="none";
  renderPasscode();
};
$("nav_admin").onclick = ()=>{ showAdminPanel(); };
$("nav_rank").onclick = ()=>{ showRankings(); };
$("nav_reset").onclick = ()=>{ renderPasscode(); toast("Reset complete"); };

(async function init(){
  await loadConfigs();
  renderPasscode();
})();
</script>

</body>
</html>
